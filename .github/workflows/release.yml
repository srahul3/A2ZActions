name: 'publish-action'
on: # rebuild any PRs and main branch changes
  release:
    types: [created, edited]
  repository_dispatch:
    types: [actions-package-migrate]

jobs:
  package-and-publish: # make sure the action works on a clean machine without building
    runs-on: ubuntu-latest
    outputs:
      output1: ${{ steps.ref.outputs.value }}
    steps:
      - name: Set the git_tag from event
        id: ref
        run: |
          ref=""
          if [ ${{ github.event.payload.release.tag_name}} != '' ]
          then
            echo 'resolving the `ref` from the release event'
            ref=${{ github.event.payload.release.tag_name}}
          elif [ ${{ github.event.client_payload.release.tag_name}} != '' ]
          then
            echo 'resolving the `ref` from the migration event'
            ref=${{ github.event.client_payload.release.tag_name}}
          else
            exit 1          
          echo 'resolved `ref` is $ref'
          echo "value=$ref" >> $GITHUB_OUTPUT
      - name: Checking out!
        uses: actions/checkout@v3
        with:
           ref: ${{ steps.ref.outputs.value }}
       
      - name: Publish action 
        uses: actions-on-packages/package-action@0.4.1
