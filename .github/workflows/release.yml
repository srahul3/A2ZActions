name: 'publish-action'
on: # rebuild any PRs and main branch changes
  release:
    types: [created, edited]
  repository_dispatch:
    types: [actions-package-migrate]

jobs:
  package-and-publish: # make sure the action works on a clean machine without building
    runs-on: ubuntu-latest    
    steps:
      - name: Set the git_tag env
        env:
          RELEASE_REF: ${{ github.event.payload.release.tag_name}}
          MIGRATION_REF: ${{ github.event.client_payload.release.tag_name}}
        run: |
          if ${RELEASE_REF}; then
            echo 'resolving the `ref` from the release event'
            echo "ref=${RELEASE_REF}" >> $GITHUB_ENV
          elif ${MIGRATION_REF}; then
            echo 'resolving the `ref` from the release event'
            echo "ref=${MIGRATION_REF}" >> $GITHUB_ENV
          else
            exit 1
          fi
          
      - name: Set the git_tag from event
        id: ref
        run: |
          ref=""
          if [ ${{ github.event.payload.release.tag_name}} != '' ]
          then
            echo 'resolving the `ref` from the release event'
            ref=$(echo "${{ github.event.payload.release.tag_name}}")
          elif [ ${{ github.event.client_payload.release.tag_name}} != '' ]
          then
            echo 'resolving the `ref` from the migration event'            
            ref=$(echo "${{ github.event.client_payload.release.tag_name}}")
          else
            exit 1          
          echo 'resolved ref is $ref'
          echo "value=$ref" >> $GITHUB_OUTPUT
      - name: Checking out!
        uses: actions/checkout@v3
        with:
           ref: ${{ steps.ref.outputs.output1 }}
       
      - name: Publish action 
        uses: actions-on-packages/package-action@0.4.1
